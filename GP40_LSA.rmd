---
title: "GP40 LSA"
author: "Yamé Meyvaert"
date: "2024-11-28"
output: html_document
---

## Loading the data

Installing and loading the libraries:

```{r}
#install.packages("tidyverse")
library(tidyverse)
library(readxl)
```

```{r}
cancer_dataset <- read_csv('metadata.csv')
cancer_abundances <- read_excel('abundances.xlsx')
```

###Data exploration Metadata

Checking datatypes:
```{r}
str(cancer_dataset)
```

Converting datatypes (cleaning the data):
```{r}
cancer_dataset$Gender <- as.factor(cancer_dataset$Gender)
cancer_dataset$Proteomic_Subtype <- as.factor(cancer_dataset$Proteomic_Subtype)
cancer_dataset$`Diameter_of_tumor_(cm)` <- as.numeric(cancer_dataset$`Diameter_of_tumor_(cm)`)
cancer_dataset$Survival_status <- as.factor(cancer_dataset$Survival_status)
cancer_dataset$Recurr_status <- as.factor(cancer_dataset$Recurr_status)

#checking for correct converting
str(cancer_dataset)
```

Check the header
```{r}
head(cancer_dataset)
```

Checking for missing values:
```{r}
missing_values <- colSums(is.na(cancer_dataset))
print(missing_values)
```

Interpretation: 7 missing values in Diameter_of_tumor_(cm) column and 10 in Tumor_cellularity_(%).

Missing data visualisation:
```{r}
#install.packages("naniar")
library(naniar)

vis_miss(cancer_dataset)       # Heatmap van missende waarden
gg_miss_var(cancer_dataset)    # Barplot van missende waarden per kolom
```

Basic stats for each of the columns:
```{r}
summary(cancer_dataset)
```

Distribution of the data
```{r}
cancer_dataset %>%
  summarise(across(where(is.numeric), list(mean = mean, sd = sd, min = min, max = max), na.rm = TRUE))
```

```{r}
cancer_dataset%>%
  count(Proteomic_Subtype)
```

###Data exploration Abundances data

```{r}
str(cancer_abundances)
```

Check the header
```{r}
head(cancer_abundances)
```

```{r}
cancer_abundances %>%
  mutate(missing_count = rowSums(is.na(.)))%>%
  select(ID, missing_count)
```

```{r}
summary(cancer_abundances)
```


Hypothese 1:

Hypotheses:
Null hypothesis (H₀): The median Tumor Cellularity is the same across all proteomic subtypes. 
Alternative hypothesis (Hₐ): At least one Proteomic Subtype has a different median Tumor Cellularity. 

Missing values:
```{r}
vis_miss(cancer_dataset)       # Heatmap of missing values
gg_miss_var(cancer_dataset)    # Barplot of missing values
```
Check how many NA values in Tumor cellularity:
```{r}
sum(is.na(cancer_dataset$`Tumor_cellularity_(%)`))
```
Random? Or not random?
```{r}
table(is.na(cancer_dataset$Proteomic_Subtype), is.na(cancer_dataset$`Tumor_cellularity_(%)`))

# Contingency table for missingness
missing_table <- table(is.na(cancer_dataset$Proteomic_Subtype), is.na(cancer_dataset$`Tumor_cellularity_(%)`))

# Chi-squared test
chisq.test(missing_table)

```
INterpretation: the p-value is below 0.05 which means that the missingness of the values is not random and therefore we can't remove them from the column. 

```{r}
#install.packages("naniar")
library(naniar)

#Plot Missingness:

# Check missing data patterns
vis_miss(cancer_dataset)  

```

Replace NA with median:
```{r}
# Calculate the median while ignoring NA values
median_value <- median(cancer_dataset$`Tumor_cellularity_(%)`, na.rm = TRUE)

# Replace NA values with the calculated median
cancer_dataset$`Tumor_cellularity_(%)`[is.na(cancer_dataset$`Tumor_cellularity_(%)`)] <- median_value

# Print the column to check if NAs were replaced
print(cancer_dataset$`Tumor_cellularity_(%)`)

```

Filter out outliers:
```{r}
ggplot(cancer_dataset, aes(x = Proteomic_Subtype, y = `Tumor_cellularity_(%)`, fill = Proteomic_Subtype)) +
  geom_boxplot(outlier.color = "purple", outlier.shape = 8) +
  theme_minimal() +
  labs(title = "Tumor Cellularity by Proteomic Subtype", y = "Tumor Cellularity (%)", x = "Proteomic Subtype")

```

```{r}
df <- cancer_dataset %>% filter(`Tumor_cellularity_(%)` < quantile(`Tumor_cellularity_(%)`, 0.99))
ggplot(cancer_dataset, aes(x = Proteomic_Subtype, y = `Tumor_cellularity_(%)`)) +
  geom_boxplot(fill = "lightpink") +
  theme_minimal()
```
 => there is no difference when filtered on 99% quantile. 


###Data visualisation

Histogram for numerical values
```{r}
ggplot(cancer_dataset, aes(x = `Tumor_cellularity_(%)`)) +
  geom_histogram(binwidth = 5, fill = "red", color = "black") +
  theme_minimal()
```

```{r}
cancer_dataset %>% ggplot(aes(x = `Tumor_cellularity_(%)` , fill = Proteomic_Subtype)) + geom_histogram() +theme_classic()
```

Boxplot:
```{r}
ggplot(cancer_dataset, aes(x = Proteomic_Subtype, y = `Tumor_cellularity_(%)`)) +
  geom_boxplot(fill = "lightgreen") +
  theme_minimal()
```
Normal distribution per Subtype:
```{r}
library(dplyr)

# Perform Shapiro-Wilk test for normality on each subtype
normality_results <- cancer_dataset %>%
  filter(!is.na(`Tumor_cellularity_(%)`)) %>%  # Remove rows with NA values
  group_by(Proteomic_Subtype) %>%             # Group by subtype
  summarise(
    shapiro_p_value = shapiro.test(`Tumor_cellularity_(%)`)$p.value
  )

print(normality_results)

```
A small p-value (< 0.05) suggests the data is not normally distributed.

Visualisation:
```{r}
ggplot(cancer_dataset, aes(x = `Tumor_cellularity_(%)`, fill = Proteomic_Subtype)) +
  geom_density(alpha = 0.5) +
  labs(title = "Density Plot of Tumor Cellularity by Subtype", 
       x = "Tumor Cellularity (%)",
       y = "Density") +
  theme_minimal()
```

Tumor cellullarity data are not normally ditributed per Proteomic Subtype

```{r}

# Add 1 to avoid issues with log(0)
ggplot(cancer_dataset, aes(x = log(`Tumor_cellularity_(%)` + 1), fill = Proteomic_Subtype)) +
  geom_density(alpha = 0.5) +
  labs(
    title = "Density Plot of Log-Transformed Tumor Cellularity by Subtype", 
    x = "Log(Tumor Cellularity (%) + 1)",
    y = "Density"
  ) +
  theme_minimal()
```
Since the log transformation did not result in approximate normality, nonparametric statistical methods that do not assume normality will be considered for further analysis.

P-values testing: 
```{r}
normCel <- cancer_dataset %>%
  group_by(Proteomic_Subtype) %>%
  summarize(p_value = t.test(`Tumor_cellularity_(%)`)$p.value)

# Print results
print(normCel)
```


Kruskal-Wallis test
```{r}
kruskal.test(`Tumor_cellularity_(%)` ~ Proteomic_Subtype, data = cancer_dataset)
```
Interpretation: With a p-value of 
0.01354, which is less than the common significance level (α=0.05), the test result is statistically significant.
This means that there is strong evidence to reject the null hypothesis.
At least one of the Proteomic_Subtype groups has a significantly different median Tumor_cellularity_(%).

Since the Kruskal-Wallis test is an omnibus test, it doesn't specify which groups differ. To identify the specific groups with differing medians, you can perform pairwise post-hoc tests:

```{r}
pairwise.wilcox.test(cancer_dataset$`Tumor_cellularity_(%)`, 
                     cancer_dataset$Proteomic_Subtype, 
                     p.adjust.method = "bonferroni")


#Visualisation:
ggplot(cancer_dataset, aes(x = Proteomic_Subtype, y = `Tumor_cellularity_(%)`, fill = Proteomic_Subtype)) +
  geom_boxplot() +
  theme_minimal() +
  labs(title = "Tumor Cellularity by Proteomic Subtype", y = "Tumor Cellularity (%)")

```
Interpretation: Results Interpretation
- S-I vs S-II:
Adjusted p-value = 1.000.
There is no statistically significant difference in the median Tumor_cellularity_(%) between subtypes S-I and S-II.

- S-I vs S-III:
Adjusted p-value = 0.059.
This is not significant at the 0.05 level. You might consider the difference to be marginal or weak evidence against the null hypothesis.

- S-II vs S-III:
Adjusted p-value = 0.026.
This indicates a statistically significant difference in the median Tumor_cellularity_(%) between subtypes S-II and S-III at the 0.05 level.

The warning occurs due to ties in Tumor_cellularity_(%), which is common with real-world data. This doesn't invalidate your results:

Monte Carlo approximation for more robust p-values:
```{r}
pairwise.wilcox.test(cancer_dataset$`Tumor_cellularity_(%)`, 
                     cancer_dataset$Proteomic_Subtype, 
                     p.adjust.method = "bonferroni", 
                     exact = FALSE)

```
With the Monte-Carlo approximation there is no difference in p-values. When ties are few and the data size is reasonable, the normal approximation (used in exact = FALSE) provides a good estimate of the p-values. Therefore thee approximate p-values provided by the pairwise Wilcox test are reliable and consistent with the results generated via Monte Carlo simulations.


The Wilcoxon test is less sensitive to outliers.

Hypothese 2:

H₀: Age, gender, and Disease-free survival have no statistically significant effect on Recurrence Status.  
Hₐ: At least one of the independent variables (age, gender, or Disease-free survival) has a statistically significant effect on Recurrence Status. 

Check missing values:
```{r}
#install.packages("naniar")
library(naniar)

#Plot Missingness:

# Check missing data patterns
vis_miss(cancer_dataset)  # naniar package

```
There are no missing values in Age, gender, disease free survival and recurrence status

Filter out oultiers:
```{r}
df <- cancer_dataset %>% filter(age < quantile(age, 0.99))
ggplot(cancer_dataset, aes(x = Recurr_status, y = age)) +
  geom_boxplot(fill = "lightpink") +
  theme_minimal()
```
```{r}
df <- cancer_dataset %>% filter(`Disease_free_survival_(m)` < quantile(age, 0.99))
ggplot(cancer_dataset, aes(x = Recurr_status, y = `Disease_free_survival_(m)`)) +
  geom_boxplot(fill = "lightpink") +
  theme_minimal()
```
```{r}
ggplot(cancer_dataset, aes(x = Recurr_status, y = age, fill = Recurr_status)) +
  geom_boxplot(outlier.color = "purple", outlier.shape = 8) +
  theme_minimal() +
  labs(title = "Age by Recurrence status", y = "Age", x = "Recurrence status")
```
```{r}
ggplot(cancer_dataset, aes(x = Recurr_status, y = `Disease_free_survival_(m)`, fill = Recurr_status)) +
  geom_boxplot(outlier.color = "purple", outlier.shape = 8) +
  theme_minimal() +
  labs(title = "Disease free survival by Recurrence status", y = "Age", x = "Recurrence status")
```
No outliers present in Age and disease free survival

Distribution:
```{r}
ggplot(cancer_dataset, aes(x = age)) +
  geom_histogram(binwidth = 5, fill = "red", color = "black") +
  theme_minimal()
```

```{r}
library(ggpubr)
ggqqplot(cancer_dataset$age)+
  ggtitle("Disease free survival")
```
P-values testing with Shapiro for normal distribution:
```{r}
cancer_dataset$age <- as.numeric(as.character(cancer_dataset$age))

shapiro.test(cancer_dataset$age)
```
The results of your Shapiro-Wilk test indicate the following:

Test Statistic (W): 
W=0.98504
The closer this value is to 1, the more the data resembles a normal distribution.

p-value: 
p=0.313

A p-value > 0.05 suggests that we fail to reject the null hypothesis, which means there is no significant evidence to suggest that the data is not normally distributed.

Interpretation
Based on these results, the age data in cancer_dataset appears to follow a normal distribution. While this doesn't guarantee perfect normality, it suggests that deviations from normality are not statistically significant.

```{r}
library(ggpubr)
ggqqplot(cancer_dataset$`Disease_free_survival_(m)`)+
  ggtitle("Disease free survival")


shapiro.test(cancer_dataset$`Disease_free_survival_(m)`)
```
The data for Disease_free_survival_(m) is not normally distributed.


Histograms:
```{r}
ggplot(data = cancer_dataset, aes(x = age,
                     fill = Recurr_status))+
  geom_histogram()+
  theme_classic()
```
```{r}
ggplot(data = cancer_dataset, aes(x = `Disease_free_survival_(m)`,
                     fill = Recurr_status))+
  geom_histogram()+
  theme_classic()
```
The data does not need to be normally distributed for the logistic regression model. 

Logistic model:
```{r}
blm_recurr <- glm(Recurr_status ~ age+Gender+`Disease_free_survival_(m)`, data=cancer_dataset, family="binomial" )

summary(blm_recurr)
```
Based on the p-values only the parameter Disease free survival is significant.

Odds ratio:
```{r}
odds <- exp(coef(blm_recurr))
odds
```
Interpretation:
Odds Ratio for Disease_free_survival_(m):
OR=0.9639 this indicates that for every one-unit increase in Disease-free survival (in months), the odds of recurrence decrease by about 1−0.964≈3.6%, holding all other variables constant.

Since 
OR<1, longer disease-free survival is associated with reduced odds of recurrence.

```{r}
#install.packages("forestmodel")
library(forestmodel)
forest_model(blm_recurr)
```
With these results there is a possibility to make a Kaplan-Meier plot with disease free survival and the recurrence status:
```{r}
#install.packages(c("survival","survminer"))
library(survival)
library(survminer)
```

```{r}
cancer_dataset %>%
  group_by(Recurr_status) %>%
  summarise(n())
```

Kaplan-Meier plot:
```{r}
# create the surv object
surv_object <- Surv(cancer_dataset$`Disease_free_survival_(m)`, as.numeric(cancer_dataset$Recurr_status))

# fit a KM curve to the data
fit <- survfit(surv_object ~ Recurr_status, data=cancer_dataset)
summary(fit)
```
```{r}
# plot this curve
ggsurvplot(fit, data = cancer_dataset,
           pval = TRUE, conf.int = TRUE,
           risk.table = TRUE, # Add risk table
           risk.table.col = "strata", # Change risk table color by groups
           linetype = "strata", # Change line type by groups
           ggtheme = theme_classic()) # Change ggplot2 theme
```
Log rank test:
```{r}
fitdif <- survdiff(surv_object ~ Recurr_status, data=cancer_dataset)
fitdif
```

Interpretation:
n first instance we could look to the p-value that comes out of the survdif analysis. In this case the p-value is lower than 2e-16. We could thus accept or alternative hypothesis and state that the two groups have a different Disease free survival. We could also look to the plot we made with ggsurvplot(). The confidence intervals are not overlapping, and the p-value is lower than 0.001. Both are an indication that the two groups have indeed a different Disease free survival. At the moment we know that there are differences, but how big is this difference? You might get an indication from your plot, by reading the median survival time. Which is the moment where 50% of the patients in that group died. We can see that this is not reached for the non-recurrence patients and its about 10 months for the Recurrence patients.
